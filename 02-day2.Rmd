---
output: html_document
editor_options: 
  chunk_output_type: inline
---
# An die Daten {#day2}

```{r include=FALSE}
knitr::opts_chunk$set(eval = TRUE)
```

## Workflow einer Datenauswertung

```{r,fig.align='center', fig.cap="Quelle: @wickhamDataScienceImport2017", echo=FALSE}
knitr::include_graphics("img/workflow.png")
```

## Rmarkdown

[Rmarkdown guide](https://bookdown.org/yihui/rmarkdown/)

```{r}
# demo

# create new rmd

# knit rmd

# Clear document

# Add your own name, code etc.

# Show resources
```

## Wiederholung Tag 1

```{r}
# Was ergibt
# c("12", 13, 14)[2] + 1
# Warum?

# Erstelle einen Vektor x mit den Zahlen von 1 bis 10
x <- 1:10

# Erstelle noch einen Vektor und nenne ihn y
y <- x

# Plotte die bei Vektoren (Scatterplot)
plot(x, y)

# Lege eine Linie durch die Datenpunkte,
model <- lm(y ~ x)
abline(model, col = "red")
# Wie erfahren wir mehr über das resultierende Objekt?
# (Zwei wichtige Funktionen!)
# str(model)
# ?lm
# lm() # press F1
```

## Reading Data

`readr`-package

```{r}
# demo readr
# load tidyverse
library(tidyverse)
# show package namespace
# readr::
# explain function names
# read_

# Create Data with tibble
# name (char), hairlengths (0,1) , row (1,2)
# see excel.

# Show data in Excel
# explain two types of csvs, tsv etc.

# Read data with read_csv
students <- read_csv("data/students.csv")
students

# Write Data with write_csv()
# write_csv2(students, "data/students2.csv")

# Mention the readxl package
# readxl::read_excel("data/students.xlsx")
```


## The pipe and dplyr verbs

The `dplyr` package and the pipe (`%>%`)

```{r}
# Demo pipe

```

Dplyr verbs:

- select
- filter
- arrange
- mutate
- summarise

- count

Dpylr adverbs

- group_by

**select**

```{r}
# demo select
# e.g. name and row
# excercise: select all but one column
```

**filter**

```{r}
# demo filter
# show only the students in the first row
```

**mutate**

```{r}
# demo mutate
# convert heirlength from 0 and 1 to "s" and "l"

# Add the length of the name as a new column

```

**arrange**

```{r}
# demo arrange
# arrange by name lengths
```

**count**

```{r}
# demo count
```

**summarise**

```{r}
# demo summarise
# what is the average name length
```

**group_by and summarise**

```{r}
# demo
# do students with longer hair have longer names on average?
```

**ungroup**

```{r}
# demo 
```


## Was ist Wahrscheinlichkeit?

Es gibt zwei Konzepte von Wahrscheinlichkeit (Probability, $P$ ):

- Probability inside your head: strength of belief; may vary among people
- Probability „out there“: long-term frequency of an event;
can be empirically measured or predicted from a model [@motulsky2017].

### Beispiel:

Kategorische / diskrete Daten: Blind aus einem "Hut" ziehen.

```{r, eval = FALSE}
# Code
# create a "hat" of hairlengths
# with the numbers observed in our course

# sample / draw from said hat
# the same number of observed long haired in first row

# Look at the help for sample (default: replace = FALSE)

# How many in this sample have long hair?

# Simulate
# Explain for-loop

## Simulation
# set N
# create empty vector for the sum from each draw
# loop over 1:N, sample, XXX from the hat, count "l", assign the result

# Histogram, Mean, Median
# histogram of results
# mean of results
# median
# Talk about difference betweeen mean and median
# demonstrate with custom made vectors

# How surprised should we be? -> Calculate probabilty for random event
# sum of sum greater than or equal to observed frequency

```

### P-Values

Eingeführt in den 1920-ern von Ronald Fisher:

> _"The P value is defined as the probability, under the assumption of no effect or no difference (the null hypothesis), of obtaining a result equal to or more extreme than what was actually observed."_
> $-$ (Original: [Statistical Methods for Research Workers](https://en.wikipedia.org/wiki/Statistical_Methods_for_Research_Workers)) [@fisher1990]

Nach Konvention: p ≤ 0.05 wird "significant" genannt.

In other words, a p-Value is...

> _"... a measure of how surprised you should be if there is no actual difference […], but you got data suggesting there is"_
>  $-$ Alex Reinhart [@reinhart2015]



```{r}
# Calculate the exact p-value:
# hypergeometric distribution
# Cummulative probabilities!
# default: P(X <= x)
# phyper
# long_hair_numbers >= 4
# 1 - phyper(q = 3, m =  4, n =  6, k =  5)


barplot(dhyper(x = 0:5, m = 4, n =  6, k =  5), names.arg = 0:5)
# P(X ≥ 6) = 1 - P(X ≤ 5)
```


### Resourcen

- [Seeing Theory](https://seeing-theory.brown.edu/)


## Transfer to new Data

Starwars

```{r}
# Preview the dataset

# select the columns name, height, mass, gender

# who is the heaviest?

# convert height from cm to m

# which gender is taller in StarWars?

# Is a summary by mean really the best thing to do?

# Look at the distributions

```





## Visualize

```{r}
# starwars %>%
#   select(height, mass) %>%
#   ggplot(aes(x = mass, y = height)) +
#   geom_point()
```

```{r}
# starwars %>%
#   filter(mass > 1000) %>%
#   select(name)
```

```{r, fig.cap="Jabba the Hut, Quelle: Wikipedia", echo=FALSE}
knitr::include_graphics("img/jabba.png")
```


## Transform 


```{r}
# starwars <-
# starwars %>%
#   filter(mass < 1000) %>%
#   mutate(height = height / 100) %>% 
#   arrange(height)
```

```{r}
# p <- 
# starwars %>%
#   ggplot(aes(x = mass, y = height, color = species, label = name)) +
#   geom_point()
# 
# plotly::ggplotly(p)
```

```{r}
# hist(starwars$height)
```

```{r}
# starwars %>%
#   filter(!is.na(height), !is.na(gender)) %>%
#   ggplot(aes(height, fill = gender)) +
#   geom_histogram(alpha = 0.8, position = "identity") +
#   theme_bw() +
#   scale_fill_brewer(type = "qual")
```

```{r}
# starwars %>%
#   filter(!is.na(height), !is.na(gender)) %>%
#   ggplot(aes(height, fill = gender)) +
#   geom_histogram(alpha = 1, position = "identity") +
#   theme_bw() +
#   scale_fill_brewer(type = "qual") +
#   facet_wrap(~gender)
```


```{r}
# starwars %>%
#   filter(!is.na(height), !is.na(gender)) %>%
#   ggplot(aes(height, fill = gender)) +
#   geom_density(alpha = 0.8) +
#   theme_bw() +
#   scale_fill_brewer(type = "qual")
```


```{r}
# starwars %>% 
#   group_by(species) %>% 
#   summarise(
#     SD = sd(mass, na.rm = TRUE),
#     mass = mean(mass, na.rm = TRUE)
#     ) %>% 
#   arrange(-mass) %>%
#   filter(!is.nan(SD)) %>% 
#   ggplot(aes(x = species, y = mass)) +
#   geom_col(fill = "#0038D1", width = 0.8) +
#   geom_errorbar(aes(ymin = mass - SD, ymax = mass + SD), width = 0.3, size = 1.2) +
#   theme_classic()
```

## Übungen

### Histogramm

Erstelle ein Histogramm für die Gewichtsverteilung aller Charaktere aus
dem StarWars-Datenset.

### Barchart

Welche Species hat die schwersten Vertreter?

### Wahrscheinlichkeit

Wie wahrscheinlich ist es, bei gleicher Verteilung von Geschlechtern im Universum,
allein durch Zufall diesen oder einen höheren Männerüberschuss in StarWars zu erhalten?

```{r}
starwars %>% count(gender)
male   <- 62
female <- 19
sum(male, female)
```

Simulate drawing 81 characters from the hat. Repeat this 1000 times. 
How often do you obtain 62 or more male characters?


```{r}
# create hat with male and female

# draw 81 with replacement

# table

# create a function that draws n from a hat and counts males

# map_int over that function

# hist

# sum draws >= 62

# calculate exact p-value with pbinom
# difference between pbinom and phyper: replacement!
```


























```{r, eval=FALSE, include=FALSE}
# create hat with male and female
hat <- c("male", "female")
# draw 81 with replacement
draw <- sample(hat, size =  81, replace = TRUE)
# table
table(draw)
# Create a function that does that and counts males
draw_from_hat <- function(hat, n) {
  draw <- sample(hat, size = n, replace = TRUE)
  sum(draw == "male")
}

# To it 100'000 times
N <- 100000
draws <- map_int(1:N, ~draw_from_hat(hat, n = 81))
# Draw a histogram
hist(draws)

# How often did we get 62 or more?
sum(draws >= 62)

# Use pbinom to find the exact p-value
1 - pbinom(62, 81, 0.5)
```



