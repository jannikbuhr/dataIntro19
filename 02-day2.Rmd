# An die Daten {#day2}

```{r include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

## Workflow einer Datenauswertung

```{r,fig.align='center', fig.cap="Quelle: @wickhamDataScienceImport2017", echo=FALSE}
knitr::include_graphics("img/workflow.png")
```

### Tidyverse: The pipe and dplyr verbs

The pipe

```{r, eval = FALSE}
# f(g(x)) = x %>% g %>% f
sum(1:10)
1:10 %>% sum()
```

Dplyr verbs:

- select
- filter
- arrange
- mutate
- summarise

Dpylr adverbs

- group_by

```{r, eval = FALSE}
starwars %>%
  select(name, height, mass, gender) %>% 
  filter(height > 100) %>% 
  arrange(desc(mass)) %>% 
  mutate(height = height / 100) %>%
  group_by(gender) %>%
  summarise(mean_mass = mean(mass, na.rm = TRUE))
```


## What is Probability

Es gibt zwei Konzepte von Wahrscheinlichkeit (Probability, $P$ ):

- Probability inside your head: strength of belief; may vary among people
- Probability „out there“: long-term frequency of an event;
can be empirically measured or predicted from a model [@motulsky2017].

### Beispiel:

Drawing from a hat (categorical / discrete data)

```{r, eval = FALSE}
# Code
# create hat of hairlengths
hat <- c(rep("l", 4), rep("s", 6))
# sample / draw from hat
# for the first row
sample(hat, size = 5)

# How many have long hair?
res <- sample(hat, size = 5)
res == "l"
sum(res == "l")

# Simulate
for (i in 1:10) {
  print(i)
}


## Simulation
N <- 1000
long_hair_numbers <- 1:N
for (i in 1:N) {
  res <- sample(hat, 5)
  long_hair_numbers[i] <- sum(res == "l")
}
# Histogram, Mean, Median
hist(long_hair_numbers, breaks = 0:5)
mean(long_hair_numbers)
median(long_hair_numbers)

# How surprised should we be? -> Calculate probabilty for random event
sum(long_hair_numbers >= 4) / N
```

### P-Values

Eingeführt in den 1920-ern von Ronald Fisher:

> _"The P value is defined as the probability, under the assumption of no effect or no difference (the null hypothesis), of obtaining a result equal to or more extreme than what was actually observed."_
> $-$ (Original: [tatistical_Methods_for_Research_Workers](https://en.wikipedia.org/wiki/Statistical_Methods_for_Research_Workers)) [@fisher1990]


Nach Konvention: p ≤ 0.05 ist “significant” p ≤ 0.01 ist “highly significant”

In other words, a p-Value is...

> _"... a measure of how surprised you should be if there is no actual difference […], but you got data suggesting there is"_
>  $-$ Alex Reinhart [@reinhart2015]

```{r, eval = FALSE}
# Calculate the exact p-value:
# hypergeometric distribution
# Cummulative probabilities!
# default: P(X <= x)

# long_hair_numbers >= 4
1 - phyper(q = 3, m =  4, n =  6, k =  5)
barplot(dhyper(x = 0:5, m = 4, n =  6, k =  5), names.arg = 0:5)
# P(X ≥ 6) = 1 - P(X ≤ 5)
```

### Resourcen

- [Seeing Theory](https://seeing-theory.brown.edu/)



## Import

Link to the data:

[https://github.com/jannikbuhr/dataIntro19/tree/master/data](https://github.com/jannikbuhr/dataIntro19/tree/master/data)


```{r, eval = FALSE}
library(tidyverse)
starwars <- read_csv("data/01_starwars_example.csv")
```

<!-- Das war einfach, wird aber nicht immer so sein. -->
<!-- Messy Data Example -->


## Visualize

```{r}
# starwars %>%
#   select(height, mass) %>%
#   ggplot(aes(x = mass, y = height)) +
#   geom_point()
```

```{r}
# starwars %>%
#   filter(mass > 1000) %>%
#   select(name)
```

```{r, fig.cap="Jabba the Hut, Quelle: Wikipedia", echo=FALSE}
knitr::include_graphics("img/jabba.png")
```


## Transform 

<!-- Jabba ist an dieser Stelle ganz klar ein Outlier. Und obwohl wir nicht einfach so Datenpunkte aus unserer Analyse entfernen können, ohne einen triftige Grund zu haben, wollen wir an dieser Stelle mal ein Auge zudrücken, um die anderen Charakter -->
<!-- vernünftig auf einen Graph packen zu können. -->

<!-- Außerdem sind die Massen in $kg$ angegeben, die Größen jedoch in $cm$ und -->
<!-- wir hätten gerne überall SI-Einheiten: -->

```{r}
# starwars <-
# starwars %>%
#   filter(mass < 1000) %>%
#   mutate(height = height / 100) %>% 
#   arrange(height)
```

```{r}
# p <- 
# starwars %>%
#   ggplot(aes(x = mass, y = height, color = species, label = name)) +
#   geom_point()
# 
# plotly::ggplotly(p)
```

```{r}
# hist(starwars$height)
```

```{r}
# starwars %>% 
#   filter(!is.na(height), !is.na(gender)) %>%
#   ggplot(aes(height, fill = gender)) +
#   geom_histogram(alpha = 0.8, position = "identity") +
#   theme_bw() +
#   scale_fill_brewer(type = "qual")
```

```{r}
# starwars %>% 
#   filter(!is.na(height), !is.na(gender)) %>%
#   ggplot(aes(height, fill = gender)) +
#   geom_histogram(alpha = 1, position = "identity") +
#   theme_bw() +
#   scale_fill_brewer(type = "qual") +
#   facet_wrap(~gender)
```


```{r}
# starwars %>% 
#   filter(!is.na(height), !is.na(gender)) %>%
#   ggplot(aes(height, fill = gender, color = gender)) +
#   geom_density(alpha = 0.8) +
#   theme_bw() +
#   scale_fill_brewer(type = "qual")
```

```{r}
# starwars %>% 
#   group_by(species) %>% 
#   summarise(
#     sd = sd(mass, na.rm = TRUE),
#     mass = mean(mass, na.rm = TRUE)
#     ) %>% 
#   arrange(-mass)
```

```{r}
# starwars %>% 
#   group_by(species) %>% 
#   summarise(
#     SD = sd(mass, na.rm = TRUE),
#     mass = mean(mass, na.rm = TRUE)
#     ) %>% 
#   arrange(-mass) %>%
#   filter(!is.nan(SD)) %>% 
#   ggplot(aes(x = species, y = mass)) +
#   geom_col(fill = "#0038D1", width = 0.8) +
#   geom_errorbar(aes(ymin = mass - SD, ymax = mass + SD), width = 0.3, size = 1.2) +
#   theme_classic()
```

## Übungen

### Histogramm

Erstelle ein Histogramm für die Gewichtsverteilung aller Charaktere aus
dem StarWars-Datenset.

### Barchart

Welche Species hat die schwersten Vertreter?

### Wahrscheinlichkeit

Wie Wahrscheinlich ist es, bei gleicher Verteilung von Geschlechtern im Universum,
allein durch Zufall diesen oder einen höheren Männerüberschuss in StarWars zu erhalten?

```{r}
starwars %>% count(gender)
male   <- 62
female <- 19
sum(male, female)
```

Simulate drawing 81 characters from the hat. Repeat this 1000 times. 
How often do you obtain 62 or more male characters?

```{r}
# create hat with male and female
hat <- c("male", "female")
# draw 81 with replacement
draw <- sample(hat, size =  81, replace = TRUE)
# table
table(draw)
# Create a function that does that and counts males
draw_from_hat <- function(hat, n) {
  draw <- sample(hat, size = n, replace = TRUE)
  sum(draw == "male")
}

# To it 100'000 times
N <- 100000
draws <- map_int(1:N, ~draw_from_hat(hat, n = 81))
# Draw a histogram
hist(draws)

# How often did we get 62 or more?
sum(draws >= 62)

# Use pbinom to find the exact p-value
1 - pbinom(62, 81, 0.5)
```

### UCBAdmissions (maybe)

```{r}
# UCBAdmissions
# a 3 dimensional array, not so much fun to work with
# we can turn it into rectangular data
df <- as_tibble(UCBAdmissions)
```



